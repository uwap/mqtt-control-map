#!/bin/sh
if [ "$TRAVIS_SECURE_ENV_VARS" != "true" ]; then
  echo "TRAVIS_SECURE_ENV_VARS not available. Aborting artifact upload."
  exit
fi

#unpack autorisation information
cat > key.gpg <<EOF
-----BEGIN PGP MESSAGE-----
Version: GnuPG v1

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
Sg5PRnJnu/8L0Q==
=ouRW
-----END PGP MESSAGE-----
EOF

echo $DEPLOY_ENCRYPTION_KEY | gpg -q --passphrase-fd 0 key.gpg
chmod og-rwx key #because it can not be used if it's world readable

#unpack host key pin
mkdir -p ~/.ssh
cat >> ~/.ssh/known_hosts <<EOF
|1|77rB9GV68KMf3QaDwxH2YiO9z4I=|yxXMIIX3291zemNIDz3ChVOv/yA= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBEZRL1Fwe8ez8PAuU8lSPPCv7YG3Iu+3Nu3+M9foZpmve6IkkXLy/L36jLEoqjIbpLB7Ti1UvKiujzHnX14Plhc=
|1|F6RqwHRXPPTzrDIXBxRA58+gois=|z0cmY0/qpO5CpCQKOUmrjeuUozg= ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBEZRL1Fwe8ez8PAuU8lSPPCv7YG3Iu+3Nu3+M9foZpmve6IkkXLy/L36jLEoqjIbpLB7Ti1UvKiujzHnX14Plhc=
EOF
chmod og-rwx ~/.ssh ~/.ssh/known_hosts

#upload artifacts
cd artifacts
{
  echo mkdir doc/$TRAVIS_COMMIT
  echo put . doc/$TRAVIS_COMMIT/node_$TRAVIS_NODE_VERSION
} | sftp -P 1922 -r -i ../key mqtt-control-map@thyristor.starletp9.de

echo "View the build results now on http://mqtt-control-map.starletp9.de/$TRAVIS_COMMIT/node_$TRAVIS_NODE_VERSION/"

